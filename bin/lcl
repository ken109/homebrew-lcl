#!/bin/bash

set -eu

function usage() {
    echo "使い方："
    echo "  lcl <種類> <アクション> <プロジェクト名(la, wp, dj時)>"
    echo ""
    echo "種類："
    echo "  base: Nginx, MySQL"
    echo "  la: Laravel開発環境"
    echo "  wp: WordPress開発環境"
    echo "  dj: Django開発環境"
    echo ""
    echo "アクション："
    echo "  start: 起動"
    echo "  stop: 停止"
    echo "  staging: ステージング"
}

function staging-non-git-wp() {
    if [ ! -e wp-settings.php ]; then
        echo "WordPressのプロジェクトではありません"
        exit 2
    fi

    echo "SSHの接続情報を入力してください。"
    echo "例：ssh user@host の場合 user@host と入力"
    echo "例：ssh example の場合 example と入力"
    read -p "SSH接続情報：" connection

    echo "圧縮中..."
    tar acf "$1.tar.gz" ./* >/dev/null

    echo "転送中..."
    scp "$1.tar.gz" "$connection":~/.tmp

    echo "処理中..."
    echo new-w "$1" | ssh -t "$connection" >/dev/null 2>&1

    rm "$1.tar.gz"

    echo "WordPressのステージングが完了しました"
    echo "URL：https://$1.ctag-w.xyz/"
}

case $# in
1)
    case $1 in
    -h | help)
        usage
        ;;
    esac
    ;;
2)
    case $1 in
    "base")
        case $2 in
        "start")
            dir=$(pwd)
            cd "$(brew --prefix)/etc/lcl/base"
            echo "起動中..."
            docker-compose up -d >/dev/null
            cd "$dir"
            ;;
        "stop")
            dir=$(pwd)
            cd "$(brew --prefix)/etc/lcl/base"
            echo "停止中..."
            docker-compose down >/dev/null
            cd "$dir"
            ;;
        *) usage ;;
        esac
        ;;
    *)
        usage
        ;;
    esac
    ;;
3)
    case $1 in
    "la")
        frame="laravel"
        ;;
    "wp")
        frame="wordpress"
        ;;
    "dj")
        frame="django"
        ;;
    *)
        usage
        exit 2
        ;;
    esac

    case $2 in
    "start")
        echo "起動中..."
        cp "$(brew --prefix)/etc/lcl/$frame.yml" ./docker-compose.yml
        sed -i '' -e "s/APP_NAME/$3/" ./docker-compose.yml
        mysql --defaults-extra-file="$(brew --prefix)/etc/lcl/mysql.conf" -h 127.0.0.1 -e "CREATE DATABASE IF NOT EXISTS \`$3\`;"
        docker-compose up -d
        echo "URL：http://$3/"
        ;;
    "stop")
        echo "停止中..."
        mysql --defaults-extra-file="$(brew --prefix)/etc/lcl/mysql.conf" -h 127.0.0.1 -e "DROP DATABASE IF EXISTS \`$3\`;"
        docker-compose down
        ;;
    "staging")
        "staging-non-git-$1" "$3"
        ;;
    *) usage ;;
    esac
    ;;
*) usage ;;
esac
